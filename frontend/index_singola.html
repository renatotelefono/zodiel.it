<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Tarocchi Vocali</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body { 
        font-family: Arial, sans-serif; 
        text-align: center; 
        padding: 40px; 
        background: #fafafa; 
      }
      h1 { font-size: 28px; margin: 0; }
      p { font-size: 18px; color: #444; }
      button { 
        padding: 15px 30px; 
        font-size: 18px; 
        margin: 20px; 
        cursor: pointer; 
      }
      #output { margin-top: 20px; font-size: 22px; color: #333; }

      .top-bar {
        display: flex;
        justify-content: space-between;
        max-width: 600px;
        margin: 0 auto;
        font-weight: bold;
      }

      #usedList {
        font-size: 16px;
        color: #333;
        text-align: left;
        white-space: pre-line;
        margin-top: 10px;
      }

      .container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 40px;
        margin-top: 30px;
      }

      .card {
        width: 180px;
        height: 280px;
        border: 2px solid #444;
        border-radius: 8px;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.6s ease-in;
      }
      .card.visible { opacity: 1; }

      #cardName { 
        font-size: 24px; 
        font-weight: bold; 
        margin-top: 15px; 
      }

      #cardMarkdown {
        max-width: 500px;
        text-align: left;
        font-size: 16px;
        line-height: 1.5;
        color: #333;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
        opacity: 0;
        transition: opacity 0.8s ease-in;
      }

      #cardMarkdown.visible { opacity: 1; }

      .error { color: red; font-weight: bold; }

      /* Contenitore titolo + pulsante */
      .header-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 10px;
      }

      .explain-btn {
        background-color: #ffd966;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="header-bar">
      <button id="explainBtn" class="explain-btn">Premi questo tasto e ti spiego cosa fare</button>
      <h1>🔮 Lettura Tarocchi </h1>
    </div>

    <p id="introText">
      Premi il tasto con il microfono con la scritta Ascolta e pronuncia il nome della carta. Verrà mostrata la carta e la sua descrizione.
    </p>

    <div class="top-bar">
      <div>Carte uscite: <span id="usedCount">0</span></div>
      <div>Carte rimanenti: <span id="remainingCount">0</span></div>
    </div>
    <div id="usedList"></div>

    <button id="startBtn">🎤 Ascolta</button>
    <button id="resetBtn">🔄 Resetta Mazzo</button>

    <p id="output">In attesa...</p>
    <div class="container" id="cardContainer"></div>

    <script type="module">
      let cards = [];
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      const output = document.getElementById("output");
      const cardContainer = document.getElementById("cardContainer");
      const usedCount = document.getElementById("usedCount");
      const remainingCount = document.getElementById("remainingCount");
      const usedList = document.getElementById("usedList");
      const introText = document.getElementById("introText").textContent;

      let availableCards = [];
      let usedCards = [];

      async function loadCards() {
        const response = await fetch('/cards.json');
        cards = await response.json();
        availableCards = [...cards];
        updateCounters();
      }

      function updateCounters() {
        usedCount.textContent = usedCards.length.toString();
        remainingCount.textContent = availableCards.length.toString();
        usedList.textContent = usedCards.join("\n");
      }

      function resetDeck() {
        availableCards = [...cards];
        usedCards = [];
        cardContainer.innerHTML = "";
        output.textContent = "In attesa...";
        updateCounters();
      }

      document.getElementById("resetBtn").addEventListener("click", resetDeck);

      // Funzione per inviare testo ad Azure TTS e riprodurlo
      async function playWithAzureTTS(text) {
        const response = await fetch("/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        if (!response.ok) {
          console.error("Errore TTS Azure:", await response.text());
          return;
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        await audio.play();
        return new Promise(resolve => {
          audio.onended = resolve;
        });
      }

      // Click sul bottone Spiegazioni
      document.getElementById("explainBtn").addEventListener("click", async () => {
        output.textContent = "🔊 Spiegazione in corso...";
        await playWithAzureTTS(introText);
        output.textContent = "In attesa...";
      });

      if (!SpeechRecognition) {
        alert("❌ Il tuo browser non supporta la Web Speech API");
      } else {
        const recognition = new SpeechRecognition();
        recognition.lang = "it-IT";
        recognition.interimResults = false;

        document.getElementById("startBtn").addEventListener("click", () => {
          console.log("🎤 Avvio microfono...");
          recognition.start();
          output.textContent = "🎧 Sto ascoltando...";
        });

        recognition.addEventListener("result", async (event) => {
          const transcript = event.results[0][0].transcript.toLowerCase();
          console.log("✅ Riconosciuto:", transcript);
          output.textContent = "Hai detto: " + transcript;

          const index = availableCards.findIndex(c => transcript.includes(c.name.toLowerCase()));
          if (index === -1) {
            cardContainer.innerHTML = `<p class="error">Carta non trovata o già uscita</p>`;
            return;
          }

          const card = availableCards.splice(index, 1)[0];
          usedCards.push(card.name);
          updateCounters();

          // Mostra la carta
          cardContainer.innerHTML = `
            <div>
              <img class="card visible" src="/cards_arcani_maggiori/${card.file}" alt="${card.name}">
              <div id="cardName">${card.name}</div>
            </div>
            <div id="cardMarkdown">Caricamento descrizione...</div>
          `;
          const cardMarkdown = document.getElementById("cardMarkdown");

          // Genera il nome file markdown
          const markdownFile = card.file.replace("RWS1909_-_", "").replace(".jpeg", ".md");

          // Carica markdown
          const res = await fetch('/descrizioni_arcani_maggiori/' + markdownFile);
          if (!res.ok) {
            cardMarkdown.innerHTML = "<p class='error'>Descrizione non trovata</p>";
            return;
          }
          let mdText = await res.text();

          // 1️⃣ Rimuove frontmatter
          mdText = mdText.replace(/^---[\s\S]*?---/, "").trim();

          // 2️⃣ Prepara testo per TTS: titoli letti, simboli rimossi
          const ttsText = mdText
            .replace(/^#+\s*/gm, "")  // Rimuove i # dai titoli
            .replace(/[*_>\-]/g,"")   // Rimuove simboli di formattazione
            .trim();

          // 3️⃣ Mostra descrizione e avvia lettura
          setTimeout(() => {
            cardMarkdown.innerHTML = marked.parse(mdText);
            cardMarkdown.classList.add("visible");

            playWithAzureTTS(ttsText);
          }, 1500);
        });
      }

      loadCards();
    </script>
  </body>
</html>
